name: Update Snapshots

on:
  workflow_dispatch:

permissions:
  contents: write # required for push commit
  pull-requests: write # required for create pr

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        network:
          - name: "polkadot"
            chains:
              - { config: "polkadot.yml", port: 9000, endpoint_var: "POLKADOT_ENDPOINT" }
              - { config: "asset-hub-polkadot.yml", port: 9001, endpoint_var: "ASSETHUBPOLKADOT_ENDPOINT" }
              - { config: "bridge-hub-polkadot.yml", port: 9002, endpoint_var: "BRIDGEHUBPOLKADOT_ENDPOINT" }
              - { config: "collectives-polkadot.yml", port: 9003, endpoint_var: "COLLECTIVESPOLKADOT_ENDPOINT" }
              - { config: "coretime-polkadot.yml", port: 9004, endpoint_var: "CORETIMEPOLKADOT_ENDPOINT" }
              - { config: "people-polkadot.yml", port: 9005, endpoint_var: "PEOPLEPOLKADOT_ENDPOINT" }
          - name: "kusama"
            chains:
              - { config: "kusama.yml", port: 9010, endpoint_var: "KUSAMA_ENDPOINT" }
              - { config: "asset-hub-kusama.yml", port: 9011, endpoint_var: "ASSETHUBKUSAMA_ENDPOINT" }
              - { config: "bridge-hub-kusama.yml", port: 9012, endpoint_var: "BRIDGEHUBKUSAMA_ENDPOINT" }
              - { config: "coretime-kusama.yml", port: 9013, endpoint_var: "CORETIMEKUSAMA_ENDPOINT" }
              - { config: "people-kusama.yml", port: 9014, endpoint_var: "PEOPLEKUSAMA_ENDPOINT" }
              - { config: "encointer-kusama.yml", port: 9015, endpoint_var: "ENCOINTERKUSAMA_ENDPOINT" }
    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
        cache: 'yarn'

    - run: yarn --immutable

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Clone Subway
      run: git clone https://github.com/AcalaNetwork/subway.git /tmp/subway

    - name: Cache Subway build
      uses: Swatinem/rust-cache@f0deed1e0edfc6a9be95417288c0e1099b1eeec3 # v2.7.7
      with:
        workspaces: /tmp/subway
        shared-key: subway-build
        save-if: ${{ github.ref == 'refs/heads/master' }}

    - name: Build Subway
      run: cargo build --release --manifest-path /tmp/subway/Cargo.toml

    - name: Update known good block numbers
      run: yarn update-known-good

    - name: Source known good block numbers
      run: |
        NETWORK_UPPER=$(echo "${{ matrix.network.name }}" | tr '[:lower:]' '[:upper:]')
        ENV_FILE="KNOWN_GOOD_BLOCK_NUMBERS_${NETWORK_UPPER}.env"
        echo "Sourcing block numbers from $ENV_FILE"
        cat "$ENV_FILE" >> $GITHUB_ENV

    - name: Start all Subway instances
      run: |
        echo "Starting all Subway instances for ${{ matrix.network.name }}..."

        echo '${{ toJSON(matrix.network.chains) }}' | jq -c '.[]' | while read chain; do
          CONFIG=$(echo $chain | jq -r '.config')
          PORT=$(echo $chain | jq -r '.port')

          echo "Starting Subway for $CONFIG on port $PORT..."
          sed "s/{{PORT}}/$PORT/g" .github/subway-configs/$CONFIG > /tmp/subway-$PORT.yml
          /tmp/subway/target/release/subway --config /tmp/subway-$PORT.yml > /tmp/subway-$PORT.log 2>&1 &
          echo $! >> /tmp/subway.pids
        done

        echo "Waiting for all Subway instances to start..."
        echo '${{ toJSON(matrix.network.chains) }}' | jq -c '.[]' | while read chain; do
          PORT=$(echo $chain | jq -r '.port')
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if grep -q "Server running at" /tmp/subway-$PORT.log 2>/dev/null; then
              echo "Subway on port $PORT started successfully!"
              break
            fi
            sleep 1
            elapsed=$((elapsed + 1))
          done

          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for subway on port $PORT"
            cat /tmp/subway-$PORT.log
            exit 1
          fi
        done

        echo "All Subway instances started successfully!"

    - name: Set endpoint environment variables
      run: |
        echo '${{ toJSON(matrix.network.chains) }}' | jq -c '.[]' | while read chain; do
          ENDPOINT_VAR=$(echo $chain | jq -r '.endpoint_var')
          PORT=$(echo $chain | jq -r '.port')
          echo "${ENDPOINT_VAR}=ws://localhost:${PORT}" >> $GITHUB_ENV
        done

    - name: Run Tests
      run: yarn test:${{ matrix.network.name }} -u --pool=threads --maxWorkers=2 --retry=3

    - name: Cleanup Subway instances
      if: always()
      run: |
        if [ -f /tmp/subway.pids ]; then
          cat /tmp/subway.pids | xargs kill || true
        fi

    - name: Commit and Create PR
      uses: actions/github-script@v6
      with:
        script: |
          const { network } = context.payload.inputs || { network: '${{ matrix.network.name }}' };
          const branchName = `update-snapshots-${network}-${context.sha.slice(0, 7)}`;
          const upperNetwork = network.toUpperCase();

          await exec.exec(`git config --global user.name 'github-actions[bot]'`);
          await exec.exec(`git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'`);

          const { stdout: status } = await exec.getExecOutput('git', ['status', '--porcelain']);
          if (!status) {
            console.log('No changes to commit.');
            return;
          }

          await exec.exec(`git checkout -b ${branchName}`);
          await exec.exec('git', ['add', '-A', `packages/${network}`]);
          await exec.exec('git', ['add', '-A', `KNOWN_GOOD_BLOCK_NUMBERS_${upperNetwork}.env`]);
          await exec.exec('git', ['commit', '-m', `Update snapshots for ${network}`]);
          await exec.exec(`git push origin HEAD:${branchName}`);

          await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Update Snapshots for ${network}`,
            head: branchName,
            base: 'master',
            body: `Update Snapshots for ${network}\n\nClose and reopen this PR to trigger CI.`,
          });
